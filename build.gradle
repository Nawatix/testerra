plugins {
    id 'com.github.jk1.dependency-license-report' version '1.13'
}

//apply plugin: 'java'
//apply plugin: 'maven'
//apply plugin: 'maven-publish' // tasks publish and publishToMavenLocal
//apply plugin: 'jacoco'

ext {
    /*
    module stuff
     */
    core_interop = project(':core-interop')
    driver_ui = project(':driver-ui')
    driver_ui_desktop = project(':driver-ui-desktop')
    image_processing = project(':image-processing')
    core = project(':core')
    report = project(':report')

    seleniumVersion = '3.141.59'
    guavaVersion = "28.1-jre"
    /*
    Flags
     */
    doNotPublish = this.&dnp

    licenseName = 'The Apache Software License, Version 2.0'
    licenseUrl = 'http://www.apache.org/licenses/LICENSE-2.0.txt'
    allLicenses = ["Apache-2.0"]

    moduleVersion = '1-SNAPSHOT'
    if (System.properties.containsKey('ttVersion')) {
        moduleVersion = System.getProperty('ttVersion')
    }
}

//doNotPublish(false)

subprojects {

    group 'eu.tsystems.mms.tic.testerra'
    version moduleVersion

    apply plugin: 'java'
    apply plugin: 'maven'
    apply plugin: 'maven-publish' // tasks publish and publishToMavenLocal
    apply plugin: 'jacoco'
    apply from: rootProject.file('publish.gradle')
//}



//subprojects {
//    apply plugin: 'java'
//    apply plugin: 'maven'
//    apply plugin: 'maven-publish' // tasks publish and publishToMavenLocal
    //apply plugin: 'jacoco' // code-coverage

    // important!
    repositories {
        mavenLocal()
        mavenCentral()
        jcenter()
    }

    sourceCompatibility = JavaVersion.VERSION_1_8
    targetCompatibility = JavaVersion.VERSION_1_8

    jacoco {
        toolVersion = "0.8.5"
    }

//    publishing {
//
//        // custom tasks for creating source/javadoc jars
//        task sourcesJar(type: Jar, dependsOn: classes) {
//            archiveClassifier.set('sources')
//            from sourceSets.main.allSource
//        }
//
//        // add source jar tasks as artifacts
//        artifacts {
//            archives sourcesJar
//        }
//
//        publications {
//            mavenJava(MavenPublication) {
//                from components.java
//                artifact sourcesJar
//            }
//        }
//
//        repositories {
//            maven {
//                url System.getProperty("deployUrl", "none")
//                credentials {
//                    username System.getProperty("deployUsername", "none")
//                    password System.getProperty("deployPassword", "none")
//                }
//            }
//        }
//    }
//
//    tasks.whenTaskAdded { t ->
//        if (t.name.startsWith("publish")) {
//            boolean e = t.project.publish.enabled
//            if (!e) {
//                println "Not running publish for " + t.project.name
//                t.enabled = false
//            }
//        }
//    }

    test {

        ignoreFailures = true
        useTestNG()
        testLogging {
            outputs.upToDateWhen { false }
            showStandardStreams = true
        }
        options {
            systemProperties(System.getProperties())
        }
    }
}

def dnp(prj) {
    prj.jar.enabled = true
    prj.publish.enabled = false
    prj.publishToMavenLocal.enabled = false

    println("Do not publish stuff from " + prj)
}

// Do not move this integration because `group` and `version` is needed for publishing
//apply from: rootProject.file('publish.gradle')

task jacocoAggregateReport(type: org.gradle.testing.jacoco.tasks.JacocoReport) {

    additionalSourceDirs(files(subprojects.sourceSets.main.allSource.srcDirs))

    def srcdirs = files(subprojects.sourceSets.main.allSource.srcDirs)
    def classdirs = files(subprojects.sourceSets.main.output)
    sourceDirectories.setFrom(srcdirs)
    classDirectories.setFrom(classdirs)

    executionData(project.fileTree(dir: '.', include: '**/build/jacoco/test.exec'))

    reports {
        html.enabled = true
        xml.enabled = true
        csv.enabled = false
    }
    onlyIf = {
        true
    }

    doFirst {
        executionData(files(executionData.findAll {
            it.exists()
        }))
    }
}

//task publishToBintray(type: GradleBuild) {
//    tasks = [
//            'core:bintrayUpload',
//            'core-interop:bintrayUpload',
//            'image-processing:bintrayUpload',
//            'driver-ui:bintrayUpload',
//            'driver-ui-desktop:bintrayUpload',
//            'surefire-connector:bintrayUpload',
//            'bmp:bintrayUpload',
//            'bup:bintrayUpload',
//            'mail-connector:bintrayUpload'
//    ]
//}
