buildscript {
    repositories {
        mavenCentral()
    }
    dependencies {
        classpath 'com.google.protobuf:protobuf-gradle-plugin:0.8.8'
    }
}

apply from: rootProject.file('release-bintray.gradle')
apply plugin: 'com.google.protobuf'
def grpcVersion = '1.28.0' // CURRENT_GRPC_VERSION
def protobufVersion = '3.10.0'
//def jacksonProtoVersion = '0.9.10-jackson2.9-proto3'
//def guavaVersion = '28.1-jre'

dependencies {
    /*
     * We set this up as transitive dependencies for :platform-connector
     * for the following reason:
     * gRPC protobuf has the google guava dependencies x.xx-android,
     * but the Android version doesn't contain 'ImmutableList.toImmutableList()'.
     * Thats why we have to exclude this dependency completely and fix it manually.
     */
    compile core
    compile("io.grpc:grpc-protobuf:${grpcVersion}")
    compile "io.grpc:grpc-stub:${grpcVersion}"
    compileOnly "com.google.protobuf:protobuf-java:$protobufVersion"
//    compileOnly "javax.annotation:javax.annotation-api:1.2"
//    compile "com.google.guava:guava:$guavaVersion"
//    implementation "com.hubspot.jackson:jackson-datatype-protobuf:$jacksonProtoVersion"
}

protobuf {
    generatedFilesBaseDir = projectDir.toString() + "/src"

    protoc { artifact = "com.google.protobuf:protoc:${protobufVersion}" }
    plugins {
        grpc { artifact = "io.grpc:protoc-gen-grpc-java:${grpcVersion}" }
    }
    generateProtoTasks {
        all().each { task ->

            task.enabled = !project.gradle.startParameter.taskNames.contains("build")

            // DO NOT USE THIS WITH GRPC PLUGIN
            /*task.builtins {
                remove java
            }*/
            task.plugins {
                grpc {
                    outputSubDir = 'java/'
                }
            }
        }
    }
}

sourceSets {
    main {
        proto {
            srcDir "proto"
        }
    }
}
